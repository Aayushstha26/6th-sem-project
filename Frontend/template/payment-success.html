<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful</title>
    <link rel="stylesheet" href="../styles/payment-success.css">
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
     <div class="container">
        <div class="success-icon"></div>
        
        <h1>Payment Successful!</h1>
        <p class="subtitle">Your transaction has been completed successfully</p>

        <div class="amount"></div>

        <div class="transaction-details">
            <div class="detail-row">
                <span class="detail-label">Payment Method</span>
                <span class="detail-value">eSewa Wallet</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Date & Time</span>
                <span class="detail-value">Dec 03, 2025 - 02:45 PM</span>
            </div>
            
            <div class="detail-row">
                <span class="detail-label">Status</span>
                <span class="detail-value" style="color: #38ef7d;">Completed</span>
            </div>
        </div>

        <div class="transaction-id">
           
        </div>

        <div class="button-group">
          <a href="/"><button class="btn btn-primary" ">Go to Home</button></a>  
            <button class="btn btn-secondary" ">Download Receipt</button>
        </div>

        <p class="footer-text">
            A confirmation email has been sent to your registered email address
        </p>
    </div>
    <script >

        const token = localStorage.getItem('accessToken');

        const urlParams = new URLSearchParams(window.location.search);
        const encodedPayload = urlParams.get('data');
       const decoded = atob(encodedPayload);
        const payload = JSON.parse(decoded);
        console.log(payload);

        try { 
            const { status, total_amount,transaction_uuid, product_code, transaction_code, signature, signed_field_names} = payload;
            const amountElement = document.querySelector('.amount');
            amountElement.textContent = `NPR ${total_amount}`;
            let statusMessage = '';
            if (status === 'success') {
                statusMessage = 'Payment Successful!';
            } else {
                statusMessage = 'Payment Failed';
            }
            let transactionIdElement = document.querySelector('.transaction-id');
            transactionIdElement.textContent = `Transaction ID: ${transaction_uuid}`;

            let d = new Date();
            let date = d.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: '2-digit' });
            let time = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            const dateTimeElement = document.querySelector('.detail-row:nth-child(2) .detail-value');
            dateTimeElement.textContent = `${date} - ${time}`;
            const res = fetch('/payment/verify-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    transaction_uuid,
                    product_code,
                    transaction_code,
                    signature,
                    total_amount
                }),
            }).then(response => response.json()).then(data => {
                localStorage.removeItem('cartCount');
            })
        } catch (error) {
            
        }

// console.log(JSON.parse(decoded));
        // if (status === 'success') {
        //     alert('Payment was successful! Thank you for your purchase.');
        // } else {
        //     alert('Payment failed or was cancelled. Please try again.');
        // }   

    </script>
</body>

    
</html>